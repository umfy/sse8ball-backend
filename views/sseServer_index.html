<!DOCTYPE html>
<html>
  <head>
    <title>8 ball SSE</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />
    <style>
      :root {
        --logo-size: 60px;
      }
      .ball {
        position: relative;
        border-radius: 50%;
        width: var(--logo-size);
        height: var(--logo-size);
        overflow: hidden;
        background: radial-gradient(
          circle at calc(var(--logo-size) / 3) calc(var(--logo-size) / 3),
          #444,
          #000
        );
      }
      .eight {
        position: absolute;
        left: calc(var(--logo-size) / 4);
        top: calc(var(--logo-size) / 4);
        width: calc(var(--logo-size) / 2);
        height: calc(var(--logo-size) / 2);
        border-radius: 50%;
        background: #fff;
        font-size: calc(var(--logo-size) / 3);
        font-family: sans-serif;
        text-align: center;
        line-height: calc(var(--logo-size) / 2);
      }
    </style>
  </head>
  <body v-scope @vue:mounted="mounted">
    <!-- NAVBAR -->

    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://bulma.io">
          <!-- <img src="https://bulma.io/images/bulma-logo.png" width="112" height="28"> -->
          <div class="ball">
            <div class="eight"><span>8</span></div>
          </div>
        </a>

        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarBasicExample"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item"> Home </a>

          <a class="navbar-item"> Documentation </a>

          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link"> More </a>

            <div class="navbar-dropdown">
              <a class="navbar-item" @click="rollPlayerName(1)">
                Losuj nazwę 1
              </a>
              <a class="navbar-item" @click="rollPlayerName(2)">
                Losuj nazwę 2
              </a>
              <hr class="navbar-divider" />
              <a class="navbar-item"> Report an issue </a>
            </div>
          </div>
        </div>

        <div class="navbar-end">
          <div class="navbar-item">
            <div class="buttons">
              <a class="button is-info" @click="sendHello">
                <strong>Send Hello</strong>
              </a>
              <a
                class="button"
                :class="{'is-danger': sseStatus}"
                @click="toggleConnection"
              >
                <strong> {{sseStatus ? 'Disconnect' : 'Connect'}} </strong>
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- PLAYROOM -->
    <div class="columns">
      <div class="column content">
        <h1 class="has-text-centered">{{players[1].name}}</h1>
        <a @click="activate(1)" class="button is-fullwidth" :class="{'is-primary': activePlayer === 1}">Aktywuj 1</a>
        <ol>
          <li v-for="log of players[1].log">{{log}}</li>
        </ol>
      </div>
      <div class="column content">
        <h1 class="has-text-centered">{{players[2].name}}</h1>
        <a @click="activate(2)" class="button is-fullwidth" :class="{'is-primary': activePlayer === 2}">Aktywuj 2</a>
        <ol>
          <li v-for="log of players[2].log">{{log}}</li>
        </ol>
      </div>
    </div>
    <script type="module">
      import { createApp } from 'https://unpkg.com/petite-vue?module'

      createApp({
        // exposed to all expressions
        sse: undefined,
        sseStatus: false,
        activePlayer: 1,
        players: [
          {
            id: 0,
            name: 'dummy',
            log: []
          },
          {
            id: 1,
            name: 'player One',
            log: []
          },
          {
            id: 2,
            name: 'player Two',
            log: []
          },
        ],
        // getters

        // methods
        toggleConnection() {
          if (this.sseStatus) {
            return this.disconnect()
          }
          this.connect()
        },

        connect() {
          this.sse = new EventSource('/sse')
          console.log('Establishing SSE connection...')
          this.sseStatus = true
          this.sse.onmessage = (evt) => {
            const data = JSON.parse(evt.data)
            this.players[data.playerId].log.push(data.value)
          }
        },

        disconnect() {
          this.sse.close()
          this.sseStatus = false
          console.log('SSE connection closed.')
        },

        async sendHello() {
          console.log('sending hello...')
          const response = await fetch('/trigger', {
            method: 'POST',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ value: 'Hello' }),
          })
          console.log(response)
        },

        async activate(id) {
          console.log('activating ', id)
          this.activePlayer = id
          const response = await fetch('/activate', {
            method: 'POST',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ playerId: id }),
          })
          console.log(response)
        },

        async rollPlayerName(id) {
          const randomNumber = Math.floor(Math.random() * 151)
          const response = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${randomNumber}`
          )
          const data = await response.json()
          const playerIndex = id
          const name = data.name.charAt(0).toUpperCase() + data.name.slice(1)
          this.players[playerIndex].name = name
        },

        mounted() {
          this.connect()
        },
      }).mount()
    </script>
  </body>
</html>
